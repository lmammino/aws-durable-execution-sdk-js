name: Integration Tests

on:
  push:
    branches: [ "main", "development" ]
    paths:
      - 'packages/lambda-durable-functions-sdk-js/**'
      - 'packages/examples/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [ "main", "development" ]
    paths:
      - 'packages/lambda-durable-functions-sdk-js/**'
      - 'packages/examples/**'
      - '.github/workflows/integration-tests.yml'
      - '.github/model/**'
  workflow_dispatch:

env:
  AWS_REGION: us-west-2

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.get-examples.outputs.examples }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: Install AWS CLI (for local act runs)
      run: |
        if ! command -v aws &> /dev/null; then
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
        fi
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install custom Lambda model
      run: |
        aws configure add-model --service-model file://.github/model/lambda.json --service-name lambda
    
    - name: Install dependencies
      run: npm run install-all
    
    - name: Build project
      run: npm run build
    
    - name: Verify SDK build
      run: |
        if [ ! -f "packages/lambda-durable-functions-sdk-js/dist/index.js" ]; then
          echo "ERROR: SDK index.js not found"
          exit 1
        fi
        if [ ! -f "packages/examples/dist/examples/hello-world.js" ]; then
          echo "ERROR: Examples hello-world.js not found"
          exit 1
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: built-examples
        path: |
          packages/examples/dist/
          packages/examples/node_modules/
          packages/lambda-durable-functions-sdk-js/dist/
          packages/lambda-durable-functions-sdk-js/package.json
          packages/dex-internal-sdk/dist-cjs/
          packages/dex-internal-sdk/package.json
          node_modules/@amzn/
          node_modules/tslib/
          node_modules/@smithy/
          node_modules/@aws-sdk/
          node_modules/uuid/
          node_modules/fast-xml-parser/
          node_modules/@aws-crypto/
          node_modules/bowser/
    
    - name: Get examples from catalog
      id: get-examples
      working-directory: ./packages/examples
      run: |
        echo "examples=$(jq -c '.examples | map(select(.integration == true))' examples-catalog.json)" >> $GITHUB_OUTPUT

  integration-test:
    needs: setup
    runs-on: ubuntu-latest
    name: ${{ matrix.example.name }}
    strategy:
      matrix:
        example: ${{ fromJson(needs.setup.outputs.examples) }}
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: built-examples
        path: .
    
    - name: Verify downloaded artifacts
      run: |
        if [ ! -f "packages/examples/dist/examples/hello-world.js" ]; then
          echo "ERROR: Examples not found in artifacts"
          exit 1
        fi
    
    - name: Install AWS CLI (for local act runs)
      run: |
        if ! command -v aws &> /dev/null; then
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
        fi
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install custom Lambda model
      run: |
        aws configure add-model --service-model file://.github/model/lambda.json --service-name lambda

    - name: Package Lambda function - ${{ matrix.example.name }}
      working-directory: ./packages/examples
      run: |
        # Extract handler file name from catalog
        HANDLER_FILE=$(echo "${{ matrix.example.handler }}" | sed 's/\.handler$//')
        npm run package -- "$HANDLER_FILE"

    - name: Deploy Lambda function - ${{ matrix.example.name }}
      working-directory: ./packages/examples
      env:
        AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
        INVOKE_ACCOUNT_ID: ${{ secrets.INVOKE_ACCOUNT_ID }}
        KMS_KEY_ARN: ${{ secrets.KMS_KEY_ARN }}
      run: |
        # Build function name for GitHub Actions
        BASE_NAME=$(echo "${{ matrix.example.name }}" | sed 's/ //g')-TypeScript
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          FUNCTION_NAME="${BASE_NAME}-PR-${{ github.event.number }}"
        else
          FUNCTION_NAME="${BASE_NAME}"
        fi
        
        # Extract handler file name from catalog
        HANDLER_FILE=$(echo "${{ matrix.example.handler }}" | sed 's/\.handler$//')
        
        # Deploy using npm script
        npm run deploy -- "$HANDLER_FILE" "$FUNCTION_NAME"
    
    - name: Invoke Lambda function - ${{ matrix.example.name }}
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
      run: |
        echo "Testing function: $FUNCTION_NAME"
        aws lambda invoke \
          --function-name "$FUNCTION_NAME" \
          --cli-binary-format raw-in-base64-out \
          --payload '{"name": "World"}' \
          --region "${{ env.AWS_REGION }}" \
          --endpoint-url "$LAMBDA_ENDPOINT" \
          /tmp/response.json
        echo "Response:"
        cat /tmp/response.json
    
    - name: Find Durable Execution - ${{ matrix.example.name }}
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
      run: |
        echo "Listing durable executions for function: $FUNCTION_NAME"
        aws lambda list-durable-executions \
          --function-name "$FUNCTION_NAME" \
          --region "${{ env.AWS_REGION }}" \
          --endpoint-url "$LAMBDA_ENDPOINT" \
          --cli-binary-format raw-in-base64-out \
          --status-filter SUCCEEDED \
          > /tmp/executions.json
        echo "Durable Executions:"
        cat /tmp/executions.json
        
        # Extract the first execution ARN for history retrieval
        EXECUTION_ARN=$(jq -r '.DurableExecutions[0].DurableExecutionArn // empty' /tmp/executions.json)
        echo "EXECUTION_ARN=$EXECUTION_ARN" >> $GITHUB_ENV
    
    - name: Get Durable Execution History - ${{ matrix.example.name }}
      if: env.EXECUTION_ARN != ''
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
      run: |
        echo "Getting execution history for: $EXECUTION_ARN"
        aws lambda get-durable-execution-history \
          --durable-execution-arn "$EXECUTION_ARN" \
          --region "${{ env.AWS_REGION }}" \
          --endpoint-url "$LAMBDA_ENDPOINT" \
          --cli-binary-format raw-in-base64-out \
          > /tmp/history.json
        echo "Execution History:"
        cat /tmp/history.json
    
    - name: Assert History - ${{ matrix.example.name }}
      if: env.EXECUTION_ARN != ''
      working-directory: ./packages/examples
      run: |
        node scripts/assert-history.js "${{ matrix.example.handler }}" "/tmp/history.json"
    
    - name: Cleanup Lambda function
      if: always()
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
      run: |
        echo "Deleting function: $FUNCTION_NAME"
        aws lambda delete-function \
          --function-name "$FUNCTION_NAME" \
          --endpoint-url "$LAMBDA_ENDPOINT" \
          --region "${{ env.AWS_REGION }}" || echo "Function already deleted or doesn't exist"
