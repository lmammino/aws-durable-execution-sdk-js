import { LocalDurableTestRunner } from "aws-durable-execution-sdk-js-testing";
import { handler } from "../parallel-wait";

// TODO: enable test when SDK lib supports waiting in concurrent operations

beforeAll(() => LocalDurableTestRunner.setupTestEnvironment());
afterAll(() => LocalDurableTestRunner.teardownTestEnvironment());

describe("parallel-wait test", () => {
    const durableTestRunner = new LocalDurableTestRunner({
        handlerFunction: handler,
        skipTime: true,
    });

    it("should complete all waits and wait for max duration", async () => {
        const execution = await durableTestRunner.run();

        const parentBlockOp = durableTestRunner.getOperation("parent-block");
        const wait1SecondOp = durableTestRunner.getOperation("wait-1-seconds");
        const wait2SecondsOp = durableTestRunner.getOperation("wait-2-seconds");
        const wait5SecondsOp = durableTestRunner.getOperation("wait-5-seconds");

        expect(execution.getResult()).toBe("Completed waits");
        expect(parentBlockOp.getChildOperations()).toHaveLength(3);
        expect(Math.max(
            wait1SecondOp.getWaitDetails()!.waitSeconds!,
            wait2SecondsOp.getWaitDetails()!.waitSeconds!,
            wait5SecondsOp.getWaitDetails()!.waitSeconds!)).toStrictEqual(5);

    });

    // TODO: possibly test with skipTime = false
});
