import { LocalDurableTestRunner} from "aws-durable-execution-sdk-js-testing";
import { handler } from '../concurrent-wait';

// TODO: enable test when SDK lib supports waiting in concurrent operations

beforeAll(() => LocalDurableTestRunner.setupTestEnvironment());
afterAll(() => LocalDurableTestRunner.teardownTestEnvironment());

describe("concurrent-wait test", () => {
    const durableTestRunner = new LocalDurableTestRunner({
        handlerFunction: handler,
        skipTime: true,
    });

    it("should complete all waits and wait for the max duration", async () => {
        const execution = await durableTestRunner.run();

        const wait1SecondOp = durableTestRunner.getOperation("wait-1-seconds");
        const wait5SecondsOp = durableTestRunner.getOperation("wait-5-seconds");
        const wait10SecondsOp = durableTestRunner.getOperation("wait-10-seconds");

        expect(execution.getResult()).toBe("Completed waits");
        expect(execution.getCompletedOperations()).toHaveLength(3);
        expect(Math.max(
            wait1SecondOp.getWaitDetails()!.waitSeconds!,
            wait5SecondsOp.getWaitDetails()!.waitSeconds!,
            wait10SecondsOp.getWaitDetails()!.waitSeconds!)).toStrictEqual(10);
    });

    // TODO: possibly test with skipTime = false
});